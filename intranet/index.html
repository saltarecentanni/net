<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="app-version" content="2.5.0">
    <title>Tiesse Matrix Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 20; 
        }
        thead th.sticky-col {
            z-index: 30;
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }
        .sync-saved { background: #22c55e; color: white; }
        .sync-info { background: #3b82f6; color: white; }
        
        /* Tab styles */
        .tab-btn {
            padding: 12px 24px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            color: #64748b;
        }
        .tab-btn:hover {
            color: #3b82f6;
            background: #f1f5f9;
        }
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag to scroll */
        .drag-scroll {
            cursor: grab;
            user-select: none;
        }
        .drag-scroll:active, .drag-scroll.dragging {
            cursor: grabbing;
        }
        /* Print styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-hide-id { display: none !important; }
            .print-hide-empty:empty { display: none !important; }
            .drag-scroll { overflow: visible !important; max-height: none !important; cursor: default; }
            table { font-size: 9px !important; border-collapse: collapse !important; }
            table th, table td { 
                border: 1px solid #94a3b8 !important; 
                padding: 3px 5px !important;
                background: white !important;
            }
            table thead th { background-color: #e2e8f0 !important; font-weight: bold !important; }
            .bg-slate-100, .bg-slate-50, .bg-amber-50 { background: transparent !important; }
            span[style*="text-shadow"] { text-shadow: none !important; }
            @page { size: landscape; margin: 6mm; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="syncIndicator" class="sync-indicator" style="display:none;"></div>
    
    <div class="w-full px-4 py-4">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 mb-1">Tiesse Matrix Network</h1>
                    <p class="text-slate-600 text-sm">Visual matrix of network devices, ports and connections</p>
                </div>
                <div class="text-right text-xs text-slate-500">
                    <div>üíæ Auto-save: LocalStorage + Server</div>
                    <div class="text-slate-600 mt-1">Version: <span id="appVersion" class="font-semibold">v2.4.0</span></div>
                </div>
            </div>
        </div>

        <script>
            (function(){
                var meta = document.querySelector('meta[name="app-version"]');
                var ver = meta ? meta.getAttribute('content') : '';
                var el = document.getElementById('appVersion');
                if (el) el.textContent = ver ? ('v' + ver) : '';
            })();
        </script>

        <!-- Actions Bar -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex flex-wrap gap-2 items-center justify-between">
                <h2 class="text-lg font-bold text-slate-800">Actions</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportExcel()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        üìä Export to Excel
                    </button>
                    <button onclick="exportJSON()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        üíæ Export JSON
                    </button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                    <button onclick="document.getElementById('importFile').click()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        üì• Import JSON
                    </button>
                    <button onclick="clearAll()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-t-xl shadow-lg">
            <div class="flex border-b overflow-x-auto">
                <button class="tab-btn active" onclick="switchTab('devices')" id="tab-devices">
                    üì± Devices
                </button>
                <button class="tab-btn" onclick="switchTab('matrix')" id="tab-matrix">
                    üîó Matrix & Connections
                </button>
                <button class="tab-btn" onclick="switchTab('active')" id="tab-active">
                    ‚ö° Active Connections
                </button>
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="bg-white rounded-b-xl shadow-lg p-4 mb-4">
            
            <!-- Tab 1: Devices -->
            <div id="content-devices" class="tab-content active">
                <!-- Add Device Form -->
                <div class="bg-slate-50 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-3">Add Device</h2>
                    <input type="hidden" id="deviceEditId" value="">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-12 gap-2 items-end">
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Rack ID *</label>
                            <input type="text" id="rackId" list="rackIdList" placeholder="Rack1" 
                                class="w-full px-3 py-1.5 border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-center text-sm">
                            <datalist id="rackIdList"></datalist>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Order *</label>
                            <input type="number" id="deviceOrder" placeholder="01" min="1" value="1"
                                class="w-full px-3 py-1.5 border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-center text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Device Name *</label>
                            <input type="text" id="deviceName" placeholder="e.g., Router-GW" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Brand/Model</label>
                            <input type="text" id="deviceBrandModel" placeholder="e.g., HPE Aruba 2930F" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Type</label>
                            <select id="deviceType" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="router">Router</option>
                                <option value="switch">Switch</option>
                                <option value="patch">Patch Panel</option>
                                <option value="firewall">Firewall</option>
                                <option value="server">Server</option>
                                <option value="wifi">WiFi AP</option>
                                <option value="isp">ISP/Provider</option>
                                <option value="router_wifi">Router Wifi</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Status</label>
                            <select id="deviceStatus" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Service</label>
                            <input type="text" id="deviceService" placeholder="DHCP, DNS, Gateway" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2 flex gap-2">
                            <button onclick="saveDevice()" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" id="saveDeviceButton">
                                Add Device
                            </button>
                            <button onclick="clearDeviceForm()" 
                                class="bg-slate-400 hover:bg-slate-500 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                                Clear
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                        <div>
                            <label class="text-xs text-slate-600 mb-1 block">Addresses (Network, IP, VLAN)</label>
                            <textarea id="deviceAddresses" placeholder="192.168.1.0/24, 192.168.1.1, 10" rows="1"
                                oninput="autoResizeTextarea(this)"
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm"></textarea>
                        </div>
                        <div class="border border-slate-200 rounded-lg p-2 bg-white">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-bold text-slate-700">Port Configuration</h3>
                                <button onclick="addPortTypeField()" type="button"
                                    class="text-xs font-semibold text-blue-500 hover:text-blue-700">+ Add Port</button>
                            </div>
                            <div id="portTypeQuantityContainer" class="space-y-1"></div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-600 mb-1 block">Notes</label>
                            <textarea id="deviceNotes" placeholder="Notes (optional)" rows="1"
                                oninput="autoResizeTextarea(this)"
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Devices List -->
                <div>
                    <h2 class="text-lg font-bold text-slate-800 mb-3">Devices List</h2>
                    <div class="overflow-x-auto" id="devicesListContainer">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Connection Matrix -->
            <div id="content-matrix" class="tab-content">
                <!-- Connection Form - Top -->
                <div class="bg-slate-50 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-3" id="connectionFormTitle">Add Connection</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-12 gap-2 items-end">
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Source Device</label>
                            <select id="fromDevice" onchange="updateFromPorts()" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Select source</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Source Port</label>
                            <select id="fromPort" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Port</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Destination Device</label>
                            <select id="toDevice" onchange="updateToPorts(); toggleExternalDest()" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Select destination</option>
                            </select>
                        </div>
                        <div class="col-span-1" id="toPortContainer">
                            <label class="text-xs text-slate-600 mb-1 block">Dest Port</label>
                            <select id="toPort" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Port</option>
                            </select>
                        </div>
                        <div class="col-span-3 hidden" id="externalDestContainer">
                            <label class="text-xs text-slate-600 mb-1 block">External Destination</label>
                            <input type="text" id="externalDest" placeholder="e.g. Fiber Optic TIM, Internet WAN, ISP Link"
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Type</label>
                            <select id="connType" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="lan">LAN</option>
                                <option value="wan">WAN/Internet</option>
                                <option value="dmz">DMZ</option>
                                <option value="trunk">Trunk/Uplink</option>
                                <option value="management">Management</option>
                                <option value="backup">Backup</option>
                                <option value="fiber">Fiber Optic</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Status</label>
                            <select id="connStatus" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Cable ID</label>
                            <input type="text" id="cableMarker" maxlength="5" placeholder="1, A"
                                class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Color</label>
                            <select id="cableColor" class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">None</option>
                                <option value="#000000">Black</option>
                                <option value="#ffffff">White</option>
                                <option value="#ef4444">Red</option>
                                <option value="#f97316">Orange</option>
                                <option value="#eab308">Yellow</option>
                                <option value="#8b4513">Brown</option>
                                <option value="#22c55e">Green</option>
                                <option value="#3b82f6">Blue</option>
                                <option value="#ec4899">Pink</option>
                                <option value="#6b7280">Gray</option>
                            </select>
                        </div>
                        <div class="col-span-2 flex gap-2">
                            <input type="hidden" id="connEditIndex" value="">
                            <button onclick="saveConnection()" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" id="saveConnectionButton">
                                Add Connection
                            </button>
                            <button onclick="cancelConnectionEdit()" id="cancelConnectionButton"
                                class="hidden bg-slate-400 hover:bg-slate-500 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <textarea id="connNotes" placeholder="Notes (optional)" rows="1"
                            oninput="autoResizeTextarea(this)"
                            class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm"></textarea>
                    </div>
                </div>
                    
                <!-- Matrix -->
                <div id="matrixPrintArea">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-bold text-slate-800">Connection Matrix</h2>
                        <div class="flex gap-2">
                            <button onclick="toggleMatrix()" id="toggleMatrixBtn" class="no-print bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-xs" style="display:none;">
                                Show All
                            </button>
                            <button onclick="printMatrix()" class="no-print bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1 px-3 rounded-lg text-xs">
                                üñ®Ô∏è Print Matrix
                            </button>
                        </div>
                    </div>
                    <div class="overflow-auto drag-scroll" id="matrixContainer" style="max-height:70vh;">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Active Connections -->
            <div id="content-active" class="tab-content">
                <div id="connectionsPrintArea">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">Active Connections</h2>
                            <p class="text-xs text-slate-500">All registered connections</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-slate-700">Total: <span id="connectionsCount">0</span> connections</span>
                            <button onclick="printConnections()" class="no-print bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1 px-3 rounded-lg text-xs">
                                üñ®Ô∏è Print List
                            </button>
                        </div>
                    </div>
                    <div id="connectionsListContainer">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load external JavaScript modules -->
    <script src="js/app.js"></script>
    <script src="js/ui-updates.js"></script>
    
    <!-- Update connections count when list updates -->
    <script>
        (function() {
            var origUpdateConnList = window.updateConnectionsList;
            window.updateConnectionsList = function() {
                origUpdateConnList.apply(this, arguments);
                var countEl = document.getElementById('connectionsCount');
                if (countEl && window.appState) {
                    countEl.textContent = appState.connections.length;
                }
            };
        })();
    </script>
</body>
</html>
