<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="app-version" content="3.1.7">
    <title>TIESSE Matrix Network - Tiesse S.P.A.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 20; 
        }
        thead th.sticky-col {
            z-index: 30;
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }
        .sync-saved { background: #22c55e; color: white; }
        .sync-info { background: #3b82f6; color: white; }
        
        /* Tab styles */
        .tab-btn {
            padding: 12px 24px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            color: #64748b;
        }
        .tab-btn:hover {
            color: #3b82f6;
            background: #f1f5f9;
        }
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag to scroll */
        .drag-scroll {
            cursor: grab;
            user-select: none;
        }
        .drag-scroll:active, .drag-scroll.dragging {
            cursor: grabbing;
        }
        /* Print styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-hide-id { display: none !important; }
            .print-hide-empty:empty { display: none !important; }
            .drag-scroll { overflow: visible !important; max-height: none !important; cursor: default; }
            table { font-size: 9px !important; border-collapse: collapse !important; width: 100% !important; }
            table th, table td { 
                border: 1px solid #334155 !important; 
                padding: 4px 6px !important;
            }
            table thead th { 
                background-color: #334155 !important; 
                color: #ffffff !important;
                font-weight: bold !important; 
            }
            table tbody tr:nth-child(even) { background-color: #f1f5f9 !important; }
            table tbody tr:nth-child(odd) { background-color: #ffffff !important; }
            /* Preserve badge colors */
            .bg-green-100 { background-color: #dcfce7 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
            .bg-blue-100 { background-color: #dbeafe !important; }
            .text-green-800 { color: #166534 !important; }
            .text-red-800 { color: #991b1b !important; }
            .text-blue-800 { color: #1e40af !important; }
            /* Matrix cell colors preserved */
            .matrix-cell { min-width: 90px !important; }
            span[style*="text-shadow"] { text-shadow: none !important; }
            @page { size: landscape; margin: 6mm; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="syncIndicator" class="sync-indicator" style="display:none;"></div>
    
    <div class="w-full px-4 py-4">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- Logo Tiesse -->
                    <img src="logoTiesse.png" alt="Tiesse S.P.A." class="h-8 w-auto">
                    <div>
                        <div class="flex items-baseline gap-2">
                            <h1 class="text-2xl font-bold text-slate-800">Matrix Network</h1>
                            <span class="text-xs text-slate-400 font-medium">by Tiesse S.P.A.</span>
                        </div>
                        <p class="text-slate-600 text-sm">Gestione visuale di dispositivi di rete, porte e connessioni</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Auth Controls -->
                    <span id="userInfo" class="text-sm font-semibold text-green-600" style="display:none;"></span>
                    <button id="loginBtn" onclick="Auth.showLoginModal()" class="view-mode-only bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-4 rounded-lg text-sm">
                        üîì Edit Mode
                    </button>
                    <button id="logoutBtn" onclick="Auth.logout()" class="edit-mode-only bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" style="display:none;">
                        üîí Logout
                    </button>
                    <div class="text-right text-xs text-slate-500">
                        <div class="font-semibold text-slate-700">Tiesse S.P.A.</div>
                        <div class="text-slate-600">Versione: <span id="appVersion" class="font-semibold">v3.0.1</span></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            (function(){
                var meta = document.querySelector('meta[name="app-version"]');
                var ver = meta ? meta.getAttribute('content') : '';
                var el = document.getElementById('appVersion');
                if (el) el.textContent = ver ? ('v' + ver) : '';
            })();
        </script>

        <!-- Actions Bar -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex flex-wrap gap-2 items-center justify-between">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-bold text-slate-800">Actions</h2>
                    <!-- Global Location Filter -->
                    <div class="flex items-center gap-2 bg-orange-50 border border-orange-300 rounded-lg px-2 py-1">
                        <select id="locationFilter" onchange="filterByLocation();" class="px-2 py-1 text-sm border-0 bg-transparent font-semibold text-orange-800 cursor-pointer focus:outline-none">
                            <option value="">üåê All Locations</option>
                        </select>
                        <datalist id="locationList"></datalist>
                        <span id="totalLocationsCount" class="bg-orange-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <!-- Stats Counters -->
                    <div class="flex items-center gap-2">
                        <button onclick="switchTab('devices')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm shadow-sm transition-all">
                            üì± <span id="totalDevicesCount">0</span> Devices
                        </button>
                        <button onclick="switchTab('active')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm shadow-sm transition-all">
                            ‚ö° <span id="totalConnectionsCount">0</span> Connections
                        </button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <!-- Edit Mode Only -->
                    <button onclick="saveNow()" class="edit-mode-only bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" style="display:none;">
                        üíæ Save Now
                    </button>
                    <!-- Public -->
                    <button onclick="exportExcel()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        üìä Export to Excel
                    </button>
                    <button onclick="exportJSON()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                        üíæ Export JSON
                    </button>
                    <!-- Edit Mode Only -->
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                    <button onclick="document.getElementById('importFile').click()" class="edit-mode-only bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" style="display:none;">
                        üì• Import JSON
                    </button>
                    <button onclick="clearAll()" class="edit-mode-only bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" style="display:none;">
                        Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-t-xl shadow-lg">
            <div class="flex border-b overflow-x-auto">
                <button class="tab-btn active" onclick="switchTab('devices')" id="tab-devices">
                    üì± Devices
                </button>
                <button class="tab-btn" onclick="switchTab('active')" id="tab-active">
                    ‚ö° Active Connections
                </button>
                <button class="tab-btn" onclick="switchTab('matrix')" id="tab-matrix">
                    üîó Matrix
                </button>
                <button class="tab-btn" onclick="switchTab('drawio')" id="tab-drawio">
                    üó∫Ô∏è Topology
                </button>
                <button class="tab-btn" onclick="switchTab('rooms')" id="tab-rooms">
                    üè¢ Salas
                </button>
                <button class="tab-btn" onclick="switchTab('logs')" id="tab-logs">
                    üìú Logs
                </button>
                <button class="tab-btn" onclick="switchTab('help')" id="tab-help">
                    ‚ùì Help
                </button>
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="bg-white rounded-b-xl shadow-lg p-4 mb-4">
            
            <!-- Tab 1: Devices -->
            <div id="content-devices" class="tab-content active">
                <!-- Add Device Form -->
                <div class="edit-mode-only bg-slate-50 rounded-lg p-3 mb-4" style="display:none;">
                    <h2 class="text-lg font-bold text-slate-800 mb-3">Add Device</h2>
                    <input type="hidden" id="deviceEditId" value="">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 xl:grid-cols-12 gap-2 items-end">
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">üìç Location *</label>
                            <input type="text" id="deviceLocation" list="locationList" placeholder="Server Room, Logistics"
                                class="w-full px-3 py-1.5 border-2 border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm font-semibold">
                            <datalist id="locationList"></datalist>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Source *</label>
                            <input type="text" id="rackId" list="rackIdList" placeholder="Rack1" 
                                class="w-full px-3 py-1.5 border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-center text-sm">
                            <datalist id="rackIdList"></datalist>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Order *</label>
                            <div class="flex gap-1 items-center">
                                <input type="number" id="deviceOrder" placeholder="01" min="0" value="1"
                                    class="w-16 px-2 py-1.5 border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-center text-sm">
                                <label class="flex items-center gap-1 px-2 py-1.5 bg-amber-50 border border-amber-300 rounded-lg cursor-pointer hover:bg-amber-100" title="Check if device is on back/rear of rack">
                                    <input type="checkbox" id="deviceRear" class="w-3.5 h-3.5 rounded border-amber-400 text-amber-600">
                                    <span class="text-xs font-semibold text-amber-700">Rear</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Device Name *</label>
                            <input type="text" id="deviceName" placeholder="e.g., Router-GW" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Brand/Model</label>
                            <input type="text" id="deviceBrandModel" placeholder="e.g., HPE Aruba 2930F" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Type</label>
                            <select id="deviceType" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="router">Router</option>
                                <option value="switch">Switch</option>
                                <option value="patch">Patch Panel</option>
                                <option value="walljack">üîå Wall Jack</option>
                                <option value="firewall">Firewall</option>
                                <option value="server">Server</option>
                                <option value="wifi">WiFi AP</option>
                                <option value="isp">ISP/Provider</option>
                                <option value="router_wifi">Router Wifi</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Status</label>
                            <select id="deviceStatus" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 mt-2">
                        <div>
                            <label class="text-xs text-slate-600 mb-1 block">Service</label>
                            <input type="text" id="deviceService" placeholder="DHCP, DNS, Gateway" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="border border-green-200 rounded-lg p-2 bg-green-50">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-bold text-green-700">üåê IP Addresses</h3>
                                <button onclick="addIPField()" type="button"
                                    class="text-xs font-semibold text-green-600 hover:text-green-800 bg-green-100 hover:bg-green-200 px-2 py-0.5 rounded transition-colors">+ Add IP</button>
                            </div>
                            <div id="deviceIPContainer" class="space-y-1 max-h-32 overflow-y-auto">
                                <input type="text" class="ip-field w-full px-2 py-1 border border-green-300 rounded text-xs font-mono bg-white" placeholder="192.168.1.1/24 or VLAN 10">
                            </div>
                        </div>
                        <div class="border border-blue-200 rounded-lg p-2 bg-blue-50">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-xs font-bold text-blue-700">üîå Port Configuration</h3>
                                <button onclick="addPortTypeField()" type="button"
                                    class="text-xs font-semibold text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 px-2 py-0.5 rounded transition-colors">+ Add Port Type</button>
                            </div>
                            <div id="portTypeQuantityContainer" class="space-y-1 max-h-48 overflow-y-auto"></div>
                            <p class="text-[10px] text-blue-600 mt-1 italic">üí° Grouped by: Copper, Fiber/SFP, WAN, Management, Telecom</p>
                        </div>
                        <div class="border border-purple-200 rounded-lg p-2 bg-purple-50">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-bold text-purple-700">üîó Links</h3>
                                <button onclick="addLinkField()" type="button"
                                    class="text-xs font-semibold text-purple-600 hover:text-purple-800 bg-purple-100 hover:bg-purple-200 px-2 py-0.5 rounded transition-colors">+ Add Link</button>
                            </div>
                            <div id="deviceLinksContainer" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Notes</label>
                            <textarea id="deviceNotes" placeholder="Notes (optional)" rows="1"
                                oninput="autoResizeTextarea(this)"
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm"></textarea>
                        </div>
                        <div class="col-span-2 flex gap-2 items-end">
                            <button onclick="saveDevice()" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" id="saveDeviceButton">
                                Add Device
                            </button>
                            <button onclick="cancelDeviceEdit()" id="cancelDeviceButton"
                                class="hidden bg-orange-400 hover:bg-orange-500 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                                Cancel
                            </button>
                            <button onclick="clearDeviceForm()" 
                                class="bg-slate-400 hover:bg-slate-500 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Devices List -->
                <div>
                    <div class="flex items-center gap-4 mb-3">
                        <h2 class="text-lg font-bold text-slate-800">Devices List</h2>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500">View:</span>
                            <button onclick="setDeviceView('cards')" id="deviceViewCards" class="px-2 py-1 text-xs font-semibold rounded bg-slate-200 text-slate-700 hover:bg-slate-300">
                                üÉè Cards
                            </button>
                            <button onclick="setDeviceView('table')" id="deviceViewTable" class="px-2 py-1 text-xs font-semibold rounded bg-blue-500 text-white">
                                üìã Table
                            </button>
                        </div>
                    </div>
                    <!-- Filter Bar for Devices -->
                    <div id="deviceFilterBar">
                        <!-- Filters will be populated by JS -->
                    </div>
                    <div class="overflow-x-auto" id="devicesListContainer">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Active Connections (with connection form) -->
            <div id="content-active" class="tab-content">
                <!-- Connection Form -->
                <div class="edit-mode-only bg-slate-50 rounded-lg p-3 mb-4" style="display:none;">
                    <h2 class="text-lg font-bold text-slate-800 mb-3" id="connectionFormTitle">Add Connection</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-12 gap-2 items-end">
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Source Device</label>
                            <select id="fromDevice" onchange="updateFromPorts()" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Select source</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Source Port</label>
                            <select id="fromPort" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Port</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-slate-600 mb-1 block">Destination Device</label>
                            <select id="toDevice" onchange="updateToPorts(); toggleExternalDest()" 
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Select destination</option>
                            </select>
                        </div>
                        <div class="col-span-1" id="toPortContainer">
                            <label class="text-xs text-slate-600 mb-1 block">Dest Port</label>
                            <select id="toPort" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">Port</option>
                            </select>
                        </div>
                        <div class="col-span-3 hidden" id="externalDestContainer">
                            <label class="text-xs text-slate-600 mb-1 block">External Destination</label>
                            <input type="text" id="externalDest" placeholder="e.g. Fiber Optic TIM, Internet WAN, ISP Link"
                                class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Type</label>
                            <select id="connType" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="lan">LAN</option>
                                <option value="wan">WAN/Internet</option>
                                <option value="dmz">DMZ</option>
                                <option value="trunk">Trunk/Uplink</option>
                                <option value="management">Management</option>
                                <option value="backup">Backup</option>
                                <option value="fiber">Fiber Optic</option>
                                <option value="wallport">Wall Jack</option>
                                <option value="external">External</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Status</label>
                            <select id="connStatus" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Cable ID</label>
                            <input type="text" id="cableMarker" maxlength="5" placeholder="1, A"
                                class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-slate-600 mb-1 block">Color</label>
                            <select id="cableColor" class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                                <option value="">None</option>
                                <option value="#000000">Black</option>
                                <option value="#ffffff">White</option>
                                <option value="#ef4444">Red</option>
                                <option value="#f97316">Orange</option>
                                <option value="#eab308">Yellow</option>
                                <option value="#8b4513">Brown</option>
                                <option value="#22c55e">Green</option>
                                <option value="#3b82f6">Blue</option>
                                <option value="#ec4899">Pink</option>
                                <option value="#6b7280">Gray</option>
                            </select>
                        </div>
                        <div class="col-span-2 flex gap-2">
                            <input type="hidden" id="connEditIndex" value="">
                            <button onclick="saveConnection()" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" id="saveConnectionButton">
                                Add Connection
                            </button>
                            <button onclick="cancelConnectionEdit()" id="cancelConnectionButton"
                                class="hidden bg-slate-400 hover:bg-slate-500 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <textarea id="connNotes" placeholder="Notes (optional)" rows="1"
                            oninput="autoResizeTextarea(this)"
                            class="w-full px-3 py-1.5 border border-slate-300 rounded-lg text-sm"></textarea>
                    </div>
                    <!-- Legend for dropdown format -->
                    <p class="text-xs text-slate-400 mt-1">‚ÑπÔ∏è Format: [SOURCE][POS] Device ‚Äî <span class="text-red-500 font-bold">*</span> disabled ‚Äî <span class="text-amber-600 text-[10px] font-semibold">(R)</span> rear</p>
                </div>

                <!-- Connections List -->
                <div id="connectionsPrintArea">
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                        <h2 class="text-lg font-bold text-slate-800">Active Connections</h2>
                        <button onclick="printConnections()" class="no-print bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1 px-3 rounded-lg text-xs">
                            üñ®Ô∏è Print List
                        </button>
                    </div>
                    <!-- Filter Bar for Connections -->
                    <div id="connFilterBar">
                        <!-- Filters will be populated by JS -->
                    </div>
                    <div id="connectionsListContainer">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Matrix (Refactored) -->
            <div id="content-matrix" class="tab-content">
                <div id="matrixPrintArea">
                    <!-- Header com t√≠tulo e controles -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">üîó Connection Matrix</h2>
                                <p class="text-xs text-slate-500">Visual map of all network connections</p>
                            </div>
                            <!-- View Mode Toggle - Left side -->
                            <div class="flex bg-slate-200 rounded-lg p-0.5 no-print">
                                <button onclick="setMatrixView('compact')" id="matrixViewCompact" class="px-3 py-1 text-xs font-semibold rounded-md bg-white text-slate-700 shadow-sm">
                                    Compact
                                </button>
                                <button onclick="setMatrixView('detailed')" id="matrixViewDetailed" class="px-3 py-1 text-xs font-semibold rounded-md text-slate-600 hover:bg-slate-100">
                                    Detailed
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 no-print">
                            <button onclick="toggleMatrix()" id="toggleMatrixBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-lg text-xs" style="display:none;">
                                Show All
                            </button>
                            <button onclick="printMatrix()" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-1.5 px-3 rounded-lg text-xs">
                                üñ®Ô∏è Print
                            </button>
                        </div>
                    </div>

                    <!-- Stats Bar -->
                    <div id="matrixStats" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 mb-4 no-print">
                        <!-- Stats will be populated by JS -->
                    </div>

                    <!-- Legend Bar (collapsible) -->
                    <div class="mb-4 no-print">
                        <button onclick="toggleMatrixLegend()" class="text-xs text-slate-500 hover:text-slate-700 flex items-center gap-1 mb-2">
                            <span id="legendToggleIcon">‚ñº</span> Connection Types Legend
                        </button>
                        <div id="matrixLegend" class="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#3b82f6">‚óè LAN</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#ef4444">‚óè WAN</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#f97316">‚óè DMZ</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#22c55e">‚óè Trunk</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#8b5cf6">‚óè Mgmt</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#eab308">‚óè Backup</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#06b6d4">‚óè Fiber</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#a78bfa">‚óè Wall Jack</span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white" style="background:#64748b">‚óè External</span>
                        </div>
                    </div>

                    <!-- Matrix Container -->
                    <div class="overflow-auto drag-scroll rounded-xl border border-slate-200 bg-white shadow-sm" id="matrixContainer" style="max-height:65vh;">
                        <div class="text-center text-slate-500 py-8">Loading...</div>
                    </div>

                    <!-- Tooltip container for hover details -->
                    <div id="matrixTooltip" class="fixed hidden z-50 bg-slate-800 text-white text-xs rounded-lg shadow-xl p-3 max-w-xs pointer-events-none">
                        <!-- Tooltip content populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Tab 4: Help -->
            <div id="content-help" class="tab-content">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold text-slate-800 mb-2">üìö Guida Utente</h1>
                        <p class="text-slate-600">Guida completa passo-passo per gestire la tua infrastruttura di rete</p>
                    </div>

                    <!-- Quick Start -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                        <h2 class="text-lg font-bold text-blue-800 mb-2">üöÄ Guida Rapida</h2>
                        <p class="text-blue-700">Questo sistema ti aiuta a documentare la tua infrastruttura di rete. Puoi aggiungere dispositivi (router, switch, server, dispositivi sparsi), definire le loro porte, creare connessioni tra di essi e visualizzare la topologia interattiva.</p>
                        <p class="text-blue-600 text-sm mt-2"><strong>üîê Autenticazione:</strong> Per modificare i dati devi effettuare il login cliccando <span class="bg-slate-600 text-white px-2 py-0.5 rounded text-xs">üîí Login</span> in alto a destra.</p>
                        <p class="text-blue-600 text-sm mt-2"><strong>‚ö†Ô∏è Importante:</strong> Clicca sempre <span class="bg-green-600 text-white px-2 py-0.5 rounded text-xs">üíæ Save Now</span> per salvare le modifiche!</p>
                    </div>

                    <!-- Section 0: Tabs Overview -->
                    <div class="bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-slate-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">üìë</span>
                            Panoramica delle Schede
                        </h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-blue-700">üì± Devices</span>
                                <p class="text-slate-600 text-sm">Gestisci dispositivi di rete: aggiungi, modifica, elimina router, switch, server, ecc.</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-green-700">‚ö° Active Connections</span>
                                <p class="text-slate-600 text-sm">Crea e gestisci connessioni fisiche tra i dispositivi.</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-purple-700">üìä Matrix</span>
                                <p class="text-slate-600 text-sm">Visualizza la matrice delle connessioni in formato tabellare.</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-orange-700">üó∫Ô∏è Topology</span>
                                <p class="text-slate-600 text-sm">Mappa interattiva con icone Cisco, drag & drop, zoom e filtri.</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-amber-700">üìã Logs</span>
                                <p class="text-slate-600 text-sm">Registro delle ultime 200 modifiche con filtri per tipo di azione.</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-slate-700">‚ùì Help</span>
                                <p class="text-slate-600 text-sm">Questa guida utente che stai leggendo.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 1: Adding Devices -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">1</span>
                            Aggiungere un Nuovo Dispositivo
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">a</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Vai alla scheda "Devices"</p>
                                    <p class="text-slate-600 text-sm">Clicca sul pulsante <span class="bg-slate-100 px-2 py-0.5 rounded">üì± Devices</span> in alto nella pagina.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">b</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Compila Location e Source</p>
                                    <p class="text-slate-600 text-sm"><strong>Location/Department:</strong> La sede o reparto (es. <code class="bg-amber-100 px-1 rounded">Sede Principale</code>, <code class="bg-amber-100 px-1 rounded">Ufficio Milano</code>). Usa il filtro Location nella barra per visualizzare solo dispositivi di una sede.</p>
                                    <p class="text-slate-600 text-sm mt-1"><strong>Source:</strong> L'identificatore del rack/posizione (es. <code class="bg-amber-100 px-1 rounded">Rack-01</code>, <code class="bg-amber-100 px-1 rounded">Server-Room-A</code>). I dispositivi con lo stesso Source saranno raggruppati insieme.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">c</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Imposta Order e Posizione</p>
                                    <p class="text-slate-600 text-sm">Il campo <strong>Order</strong> indica la posizione fisica nel rack:</p>
                                    <ul class="text-slate-600 text-sm mt-2 ml-4 list-disc space-y-1">
                                        <li><code class="bg-amber-100 px-1 rounded">1, 2, 3...</code> = Posizione nel rack (dall'alto o dal basso)</li>
                                        <li><code class="bg-amber-100 px-1 rounded">0</code> = Dispositivo sparso/isolato (non in un rack)</li>
                                    </ul>
                                    <p class="text-slate-600 text-sm mt-2"><strong>Checkbox "Rear":</strong> Seleziona se il dispositivo √® montato nella parte <strong>posteriore</strong> del rack. Apparir√† con l'indicatore <span class="bg-amber-100 text-amber-700 px-1 rounded font-bold">R</span>.</p>
                                    
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                                        <p class="font-semibold text-blue-800 text-sm">üìç Convenzione Numerazione Posizioni:</p>
                                        <ul class="text-blue-700 text-sm mt-1 ml-4 list-disc space-y-1">
                                            <li><strong>FRONTE:</strong> Numera dall'alto verso il basso in ordine crescente ‚Üí <code class="bg-blue-100 px-1 rounded">01, 02, 03, 04...</code></li>
                                            <li><strong>RETRO (R):</strong> Numera dal basso verso l'alto in ordine decrescente ‚Üí <code class="bg-blue-100 px-1 rounded">99, 98, 97, 96...</code></li>
                                        </ul>
                                        <p class="text-blue-600 text-xs mt-2">Esempio: Rack con 5 dispositivi davanti (01-05) e 3 dietro (99, 98, 97)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">d</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Inserisci il Nome del Dispositivo</p>
                                    <p class="text-slate-600 text-sm">Dai al tuo dispositivo un nome unico e descrittivo. Esempi: <code class="bg-amber-100 px-1 rounded">Tiesse-Wifi</code>, <code class="bg-amber-100 px-1 rounded">Switch-Principale</code>, <code class="bg-amber-100 px-1 rounded">Huawei TIM</code></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">e</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Aggiungi Configurazione Porte (Importante!)</p>
                                    <p class="text-slate-600 text-sm">Clicca <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded">+ Add Port</span> per definire le porte del dispositivo. Per ogni tipo di porta:</p>
                                    <ul class="text-slate-600 text-sm mt-2 ml-4 list-disc space-y-1">
                                        <li>Seleziona il tipo di porta (Eth, GbE, SFP, ecc.)</li>
                                        <li>Inserisci quante porte di questo tipo</li>
                                        <li>Esempio: Uno switch con 24 porte Ethernet ‚Üí Tipo: <code class="bg-amber-100 px-1 rounded">Eth</code>, Qty: <code class="bg-amber-100 px-1 rounded">24</code></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">f</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Clicca "Add Device"</p>
                                    <p class="text-slate-600 text-sm">Premi il pulsante blu <span class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs">Add Device</span>. Il tuo dispositivo apparir√† nella lista!</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-4">
                            <p class="text-green-800 text-sm"><strong>üí° Suggerimento:</strong> Puoi anche aggiungere:</p>
                            <ul class="text-green-700 text-sm mt-1 ml-4 list-disc">
                                <li><strong>Marca/Modello</strong> - Per identificare l'hardware</li>
                                <li><strong>4 Indirizzi IP</strong> - IP1, IP2, IP3, IP4 con maschera di rete</li>
                                <li><strong>Servizio</strong> - Descrizione del ruolo del dispositivo</li>
                                <li><strong>Links</strong> - URL multipli (documentazione, interfaccia web, ecc.)</li>
                                <li><strong>Note</strong> - Informazioni aggiuntive</li>
                                <li><strong>Status</strong> - Active o Disabled (off)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 2: Creating Connections -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">2</span>
                            Creare una Connessione tra Dispositivi
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">a</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Vai alla scheda "Active Connections"</p>
                                    <p class="text-slate-600 text-sm">Clicca su <span class="bg-slate-100 px-2 py-0.5 rounded">‚ö° Active Connections</span>. Qui √® dove crei e gestisci tutte le connessioni.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">b</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Seleziona il Dispositivo Sorgente</p>
                                    <p class="text-slate-600 text-sm">Scegli il dispositivo da dove parte il cavo. Esempio: <code class="bg-amber-100 px-1 rounded">Tiesse-Wifi</code></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">c</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Seleziona la Porta Sorgente</p>
                                    <p class="text-slate-600 text-sm">Scegli a quale porta √® collegato il cavo. Esempio: <code class="bg-amber-100 px-1 rounded">eth1</code></p>
                                    <p class="text-slate-500 text-xs mt-1">‚ö†Ô∏è Vengono mostrate solo le porte disponibili (non in uso)!</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">d</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Seleziona il Dispositivo Destinazione</p>
                                    <p class="text-slate-600 text-sm">Scegli dove va il cavo. Esempio: <code class="bg-amber-100 px-1 rounded">Switch-Principale</code></p>
                                    <p class="text-slate-500 text-xs mt-1">üí° Per connessioni esterne (come ISP), seleziona "External/Internet" e inserisci una descrizione.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">e</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Seleziona la Porta Destinazione</p>
                                    <p class="text-slate-600 text-sm">Scegli quale porta sul dispositivo destinazione. Esempio: <code class="bg-amber-100 px-1 rounded">eth13</code></p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">f</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Scegli il Tipo di Connessione</p>
                                    <p class="text-slate-600 text-sm">Seleziona che tipo di connessione √®:</p>
                                    <ul class="text-slate-600 text-sm mt-2 ml-4 list-disc space-y-1">
                                        <li><strong>LAN</strong> - Connessione di rete locale</li>
                                        <li><strong>WAN/Internet</strong> - Internet o rete esterna</li>
                                        <li><strong>Trunk/Uplink</strong> - Connessione tra switch</li>
                                        <li><strong>Management</strong> - Accesso amministrativo</li>
                                        <li><strong>Fiber Optic</strong> - Connessioni in fibra</li>
                                        <li><strong>Wall Jack</strong> - Prese LAN a muro/patch panel</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">g</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Aggiungi ID Cavo e Colore (Opzionale ma Consigliato)</p>
                                    <p class="text-slate-600 text-sm">Se i tuoi cavi hanno etichette, inserisci l'ID (es., <code class="bg-amber-100 px-1 rounded">A1</code>, <code class="bg-amber-100 px-1 rounded">15</code>). Seleziona il colore del cavo per identificarlo fisicamente.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="bg-slate-200 text-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">h</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Clicca "Add Connection"</p>
                                    <p class="text-slate-600 text-sm">Premi il pulsante verde <span class="bg-green-500 text-white px-2 py-0.5 rounded text-xs">Add Connection</span>. Fatto! ‚úÖ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2.5: Patch Panel Special Feature -->
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2">
                            <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">‚ö°</span>
                            Funzionalit√† Speciale: Patch Panel
                        </h2>
                        
                        <div class="space-y-3">
                            <p class="text-purple-700">I <strong>Patch Panel</strong> hanno una logica speciale: ogni porta pu√≤ avere <strong>2 connessioni</strong> (fronte e retro).</p>
                            
                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p class="font-semibold text-purple-900 mb-2">üìå Esempio pratico:</p>
                                <ol class="text-purple-800 text-sm space-y-2 list-decimal ml-4">
                                    <li>Un cavo viene dal <strong>wall jack</strong> nella parete ‚Üí connesso alla porta 19 del patch panel (RETRO)</li>
                                    <li>Un altro cavo va dalla porta 19 del patch panel ‚Üí connesso allo Switch D-Link porta 33 (FRONTE)</li>
                                    <li>Entrambe le connessioni sono registrate sulla stessa porta 19!</li>
                                </ol>
                            </div>
                            
                            <p class="text-purple-600 text-sm">üí° Quando selezioni le porte di un patch panel, vedrai: <code class="bg-purple-100 px-1 rounded">(Libera)</code>, <code class="bg-purple-100 px-1 rounded">(1/2 - disponibile)</code> o <code class="bg-purple-100 px-1 rounded">(2/2 - completa)</code></p>
                        </div>
                    </div>

                    <!-- Section 3: Using the Matrix -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">3</span>
                            Comprendere la Matrice delle Connessioni
                        </h2>
                        
                        <div class="space-y-4">
                            <p class="text-slate-600">La scheda Matrix mostra una griglia visuale di tutte le tue connessioni. Pensala come un foglio di calcolo dove:</p>
                            
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <ul class="text-slate-700 space-y-2">
                                    <li>üìä <strong>Righe</strong> = Dispositivi sorgente (da dove PARTONO i cavi)</li>
                                    <li>üìä <strong>Colonne</strong> = Dispositivi destinazione (dove ARRIVANO i cavi)</li>
                                    <li>üîµ <strong>Celle colorate</strong> = Esiste una connessione tra quei due dispositivi</li>
                                    <li>‚¨ú <strong>Celle vuote</strong> = Nessuna connessione esistente</li>
                                </ul>
                            </div>

                            <div class="flex items-start gap-3 mt-4">
                                <span class="text-2xl">üëÜ</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Clicca su qualsiasi cella colorata per modificare quella connessione!</p>
                                    <p class="text-slate-600 text-sm">La cella mostra: tipo di connessione, nomi delle porte e ID cavo se definito.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3.5: Network Topology -->
                    <div class="bg-orange-50 border border-orange-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-orange-800 mb-4 flex items-center gap-2">
                            <span class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">üó∫Ô∏è</span>
                            Network Topology (Mappa di Rete)
                        </h2>
                        
                        <div class="space-y-4">
                            <p class="text-orange-700">La scheda <strong>Topology</strong> mostra una mappa interattiva della tua rete con icone stile Cisco.</p>
                            
                            <div class="bg-white p-4 rounded-lg border border-orange-200">
                                <h3 class="font-bold text-orange-900 mb-2">üéõÔ∏è Controlli disponibili:</h3>
                                <div class="grid md:grid-cols-2 gap-3 text-sm">
                                    <div><strong>üìç Filtro Location:</strong> Mostra solo dispositivi di una sede</div>
                                    <div><strong>üì¶ Filtro Source:</strong> Mostra solo dispositivi di un rack</div>
                                    <div><strong>üîÑ Layout:</strong> Auto, Circle, Grid, Hierarchical</div>
                                    <div><strong>‚äû Fit View:</strong> Centra e adatta la vista</div>
                                    <div><strong>üìã Legend:</strong> Mostra legenda con conteggi dispositivi</div>
                                    <div><strong>üì∑ Export PNG:</strong> Scarica immagine della topologia</div>
                                    <div><strong>üì• Export .drawio:</strong> Esporta per Draw.io</div>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-orange-200">
                                <h3 class="font-bold text-orange-900 mb-2">üñ±Ô∏è Interazioni:</h3>
                                <ul class="text-orange-800 text-sm space-y-1 list-disc ml-4">
                                    <li><strong>Drag & Drop:</strong> Trascina i dispositivi per riposizionarli</li>
                                    <li><strong>Zoom:</strong> Usa la rotella del mouse per ingrandire/ridurre</li>
                                    <li><strong>Pan:</strong> Trascina lo sfondo per spostare la vista</li>
                                    <li><strong>Hover:</strong> Passa il mouse su un dispositivo per vedere i dettagli</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-orange-200">
                                <h3 class="font-bold text-orange-900 mb-2">üìã Legenda dispositivi:</h3>
                                <p class="text-orange-800 text-sm">Clicca <span class="bg-purple-500 text-white px-2 py-0.5 rounded text-xs">üìã Legend</span> per vedere:</p>
                                <ul class="text-orange-700 text-sm mt-2 ml-4 list-disc">
                                    <li>Conteggio per tipo di dispositivo (Router, Switch, Server, ecc.)</li>
                                    <li>Conteggio Wall Jack virtuali dalle connessioni</li>
                                    <li>Dispositivi spenti/disabilitati (badge rosso)</li>
                                    <li>Riepilogo totale dispositivi</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3.6: Activity Logs -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-amber-800 mb-4 flex items-center gap-2">
                            <span class="bg-amber-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">üìã</span>
                            Activity Logs (Registro Attivit√†)
                        </h2>
                        
                        <div class="space-y-3">
                            <p class="text-amber-700">La scheda <strong>Logs</strong> mostra le ultime 200 modifiche effettuate al sistema.</p>
                            
                            <div class="bg-white p-4 rounded-lg border border-amber-200">
                                <h3 class="font-bold text-amber-900 mb-2">üìä Filtri disponibili:</h3>
                                <div class="flex flex-wrap gap-2 text-sm">
                                    <span class="px-2 py-1 bg-slate-100 rounded">All</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded">Add</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">Edit</span>
                                    <span class="px-2 py-1 bg-red-100 text-red-800 rounded">Delete</span>
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded">Import</span>
                                </div>
                            </div>

                            <p class="text-amber-600 text-sm">üí° Ogni voce mostra: data/ora, tipo di azione, nome del dispositivo/connessione e dettagli della modifica.</p>
                        </div>
                    </div>

                    <!-- Section 4: Editing and Deleting -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">4</span>
                            Modifica e Eliminazione
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-bold text-blue-800 mb-2">‚úèÔ∏è Per Modificare un Dispositivo:</h3>
                                <ol class="text-blue-700 text-sm space-y-1 list-decimal ml-4">
                                    <li>Vai alla scheda <strong>Devices</strong></li>
                                    <li>Trova il dispositivo nella lista</li>
                                    <li>Clicca il pulsante <strong>Edit</strong></li>
                                    <li>Effettua le modifiche</li>
                                    <li>Clicca <strong>Update Device</strong></li>
                                </ol>
                            </div>

                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-bold text-green-800 mb-2">‚úèÔ∏è Per Modificare una Connessione:</h3>
                                <ol class="text-green-700 text-sm space-y-1 list-decimal ml-4">
                                    <li>Vai alla scheda <strong>Active Connections</strong></li>
                                    <li>Trova la connessione nella lista</li>
                                    <li>Clicca il pulsante <strong>Edit</strong></li>
                                    <li>Effettua le modifiche</li>
                                    <li>Clicca <strong>Update Connection</strong></li>
                                </ol>
                            </div>

                            <div class="bg-red-50 p-4 rounded-lg md:col-span-2">
                                <h3 class="font-bold text-red-800 mb-2">üóëÔ∏è Per Eliminare:</h3>
                                <p class="text-red-700 text-sm">Clicca il pulsante <strong>Del</strong> accanto a qualsiasi dispositivo o connessione. Ti verr√† chiesta conferma prima dell'eliminazione.</p>
                                <p class="text-red-600 text-xs mt-2">‚ö†Ô∏è Attenzione: Eliminare un dispositivo eliminer√† anche TUTTE le sue connessioni!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Export and Import -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">5</span>
                            Esportazione e Importazione Dati
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üìä</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Esporta in Excel</p>
                                    <p class="text-slate-600 text-sm">Clicca <span class="bg-indigo-500 text-white px-2 py-0.5 rounded text-xs">üìä Export to Excel</span> nella barra Azioni. Crea un foglio di calcolo con 3 schede: Dispositivi, Connessioni e Matrice.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üíæ</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Esporta in JSON (Backup)</p>
                                    <p class="text-slate-600 text-sm">Clicca <span class="bg-slate-500 text-white px-2 py-0.5 rounded text-xs">üíæ Export JSON</span> per scaricare un file di backup. Usalo per ripristinare i dati in seguito o trasferirli su un altro computer.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üì•</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Importa da JSON</p>
                                    <p class="text-slate-600 text-sm">Clicca <span class="bg-slate-500 text-white px-2 py-0.5 rounded text-xs">üì• Import JSON</span> e seleziona un file JSON precedentemente esportato. Questo sostituir√† tutti i dati correnti!</p>
                                    <p class="text-red-600 text-xs mt-1">‚ö†Ô∏è L'importazione richiede autenticazione e sovrascrive tutti i dati esistenti.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üñ®Ô∏è</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Stampa</p>
                                    <p class="text-slate-600 text-sm">Usa i pulsanti <span class="bg-slate-500 text-white px-2 py-0.5 rounded text-xs">üñ®Ô∏è Print</span> nelle schede Matrix o Active Connections per stampare la documentazione. Puoi stampare solo la Location/Source filtrata.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üì∑</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Esporta Topologia PNG</p>
                                    <p class="text-slate-600 text-sm">Nella scheda Topology, clicca <span class="bg-indigo-500 text-white px-2 py-0.5 rounded text-xs">üì∑ Export PNG</span> per scaricare un'immagine della mappa di rete con titolo e data.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üìê</span>
                                <div>
                                    <p class="font-semibold text-slate-700">Esporta per Draw.io</p>
                                    <p class="text-slate-600 text-sm">Nella scheda Topology, clicca <span class="bg-orange-500 text-white px-2 py-0.5 rounded text-xs">üì• Export .drawio</span> per creare un file modificabile in Draw.io/diagrams.net.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: Understanding the Interface -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="bg-teal-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">6</span>
                            Comprendere Colori e Simboli
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-bold text-slate-700 mb-2">Tipi di Connessione:</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#3b82f6"></span> LAN (Blu)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#ef4444"></span> WAN/Internet (Rosso)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#f97316"></span> DMZ (Arancione)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#22c55e"></span> Trunk/Uplink (Verde)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#8b5cf6"></span> Management (Viola)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#eab308"></span> Backup (Giallo)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#06b6d4"></span> Fiber Optic (Ciano)</div>
                                    <div class="flex items-center gap-2"><span class="w-4 h-4 rounded" style="background:#a78bfa"></span> Wall Jack (Viola chiaro)</div>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-700 mb-2">Indicatori di Stato:</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="flex items-center gap-2"><span class="px-2 py-0.5 rounded bg-green-100 text-green-800 text-xs">Active</span> Dispositivo/connessione funzionante</div>
                                    <div class="flex items-center gap-2"><span class="px-2 py-0.5 rounded bg-red-100 text-red-800 text-xs">Disabled</span> Dispositivo/connessione spento</div>
                                </div>
                                
                                <h3 class="font-bold text-slate-700 mb-2 mt-4">Intestazioni Matrice:</h3>
                                <div class="space-y-1 text-sm">
                                    <div>üè∑Ô∏è Bordo colorato = Identificatore del rack</div>
                                    <div>üî¢ Numero nel cerchio = Posizione nel rack</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ Section -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-5 mb-4">
                        <h2 class="text-xl font-bold text-amber-800 mb-4">‚ùì Domande Frequenti (FAQ)</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <p class="font-semibold text-amber-900">D: Come faccio il login per modificare i dati?</p>
                                <p class="text-amber-800 text-sm">R: Clicca il pulsante <strong>üîí Login</strong> in alto a destra. Inserisci le credenziali fornite dall'amministratore. Una volta autenticato, vedrai il pulsante <strong>üîì Logout</strong>.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Cosa significa Order = 0?</p>
                                <p class="text-amber-800 text-sm">R: Order 0 √® per dispositivi "sparsi" o isolati che non sono montati in un rack. Ad esempio: un access point sul soffitto, un router in un'altra stanza.</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Quando devo usare il checkbox "Rear"?</p>
                                <p class="text-amber-800 text-sm">R: Usa "Rear" quando un dispositivo √® montato nella parte <strong>posteriore</strong> del rack. Esempio: hai 5 dispositivi davanti (1-5) e 2 dietro. Quelli dietro avranno "Rear" selezionato.</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Cosa significa * nelle liste?</p>
                                <p class="text-amber-800 text-sm">R: Un asterisco <strong class="text-red-600">*</strong> prima del nome indica che il dispositivo √® <strong>disabilitato</strong> (Status = Disabled).</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Cosa significa (R) nelle liste?</p>
                                <p class="text-amber-800 text-sm">R: <strong class="text-amber-600">(R)</strong> indica che il dispositivo √® montato nella parte posteriore (Rear) del rack.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Come uso il filtro Location?</p>
                                <p class="text-amber-800 text-sm">R: Nella barra Azioni, seleziona una Location dal menu a tendina. Verranno mostrati solo i dispositivi di quella sede. Questo filtro si applica anche alla Matrice, Topologia e alla stampa.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Come aggiungo pi√π indirizzi IP a un dispositivo?</p>
                                <p class="text-amber-800 text-sm">R: Ogni dispositivo ha 4 campi IP (IP1-IP4). Puoi anche specificare la maschera di rete nel formato CIDR (es. <code class="bg-amber-100 px-1 rounded">192.168.1.1/24</code>).</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Come aggiungo link/URL a un dispositivo?</p>
                                <p class="text-amber-800 text-sm">R: Modifica il dispositivo e usa il campo <strong>Links</strong>. Puoi aggiungere pi√π URL (interfaccia web, documentazione, ecc.). I link appariranno come icone cliccabili nella lista dispositivi.</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Pi√π persone possono usarlo contemporaneamente?</p>
                                <p class="text-amber-800 text-sm">R: S√¨, ma attenzione: l'ultima persona a salvare sovrascriver√† le modifiche degli altri!</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Non vedo una porta di cui ho bisogno. Cosa faccio?</p>
                                <p class="text-amber-800 text-sm">R: Vai alla scheda Devices, trova il tuo dispositivo, clicca Edit e aggiungi pi√π porte usando il pulsante "+ Add Port".</p>
                            </div>
                            
                            <div>
                                <p class="font-semibold text-amber-900">D: Come faccio il backup dei miei dati?</p>
                                <p class="text-amber-800 text-sm">R: Clicca "Export JSON" regolarmente. Conserva il file scaricato in un posto sicuro. Puoi ripristinarlo usando "Import JSON".</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Come funzionano le porte del Patch Panel?</p>
                                <p class="text-amber-800 text-sm">R: Le porte del patch panel possono avere fino a 2 connessioni (fronte e retro). Questo ti permette di collegare un wall jack al retro e uno switch al fronte della stessa porta.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Come vedo le modifiche recenti?</p>
                                <p class="text-amber-800 text-sm">R: Vai alla scheda <strong>Logs</strong>. Vedrai le ultime 200 modifiche ordinate per data. Puoi filtrare per tipo (Add, Edit, Delete, Import).</p>
                            </div>

                            <div>
                                <p class="font-semibold text-amber-900">D: Posso esportare la topologia come immagine?</p>
                                <p class="text-amber-800 text-sm">R: S√¨! Nella scheda Topology clicca <strong>üì∑ Export PNG</strong>. L'immagine includer√† titolo, data e filtri attivi. Puoi anche esportare in formato Draw.io per modifiche avanzate.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center text-slate-400 text-xs py-4 border-t border-slate-200 mt-6">
                        <p class="font-semibold text-slate-600">¬© 2026 Tiesse S.P.A. ‚Äî All rights reserved</p>
                        <p class="mt-1">TIESSE Matrix Network v3.1.7</p>
                        <p class="mt-2 text-red-500 font-medium">‚ö†Ô∏è Confidential document ‚Äî Reproduction prohibited ‚Äî For internal use only</p>
                    </div>
                </div>
            </div>

            <!-- Tab: SVG Topology with Cisco Icons -->
            <div id="content-drawio" class="tab-content">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">üó∫Ô∏è Network Topology</h2>
                        <p class="text-xs text-slate-500">Interactive visualization - drag devices to reposition</p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <select id="topologyLocationFilter" onchange="filterTopologyByLocation()" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Locations</option>
                        </select>
                        <select id="topologyRackFilter" onchange="filterTopologyByRack()" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Sources</option>
                        </select>
                        <select id="drawioLayout" onchange="updateDrawioLayout()" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                            <option value="auto">Auto Layout</option>
                            <option value="circle">Circle</option>
                            <option value="grid">Grid</option>
                            <option value="hierarchical">Hierarchical</option>
                        </select>
                        <button onclick="fitDrawioView()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                            ‚äû Fit View
                        </button>
                        <button onclick="showTopologyLegend()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                            üìã Legend
                        </button>
                        <button onclick="exportDrawioPNG()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                            üì∑ Export PNG
                        </button>
                        <button onclick="exportTopologyDrawio()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                            üì• Export .drawio
                        </button>
                    </div>
                </div>
                <div id="drawioContainer" class="border border-slate-300 rounded-xl bg-white" style="height: 600px; width: 100%; overflow: hidden; position: relative;">
                    <div class="flex items-center justify-center h-full text-slate-400">
                        <p>Loading topology visualization...</p>
                    </div>
                </div>

                <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800"><strong>üí° Tip:</strong> Drag devices to reposition. Use "Export .drawio" to open in <a href="https://app.diagrams.net" target="_blank" class="text-blue-600 hover:underline font-semibold">diagrams.net</a> for advanced editing.</p>
                </div>
            </div>

            <!-- Tab: Mappa Salas -->
            <div id="content-rooms" class="tab-content">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">üè¢ Mappa delle Salas</h2>
                        <p class="text-xs text-slate-500">Planimetria fisica degli uffici con punti WallJack</p>
                    </div>
                    <select id="roomsViewMode" onchange="toggleRoomsView()" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                        <option value="map">Vista Mappa</option>
                        <option value="list">Lista Salas</option>
                    </select>
                </div>

                <!-- Vista Mappa -->
                <div id="roomsMapView" class="border border-slate-300 rounded-xl bg-white overflow-hidden" style="height: 650px; position: relative;">
                    <!-- Controles -->
                    <div id="mapControls" class="absolute top-3 left-3 z-50 flex gap-2 bg-white/95 p-3 rounded-lg border border-slate-300 shadow-lg">
                        <button id="zoomInBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold text-sm transition">üîç+</button>
                        <button id="zoomOutBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold text-sm transition">üîç-</button>
                        <button id="zoomResetBtn" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white rounded-md font-semibold text-sm transition">‚ü≤ Reset</button>
                        <span id="zoomLevel" class="px-3 py-1.5 text-sm font-semibold text-slate-700">100%</span>
                    </div>

                    <!-- Painel lateral -->
                    <div id="roomDetailsPanel" class="absolute bottom-0 left-0 w-80 bg-white/98 border-t border-r border-slate-300 shadow-lg max-h-96 overflow-y-auto rounded-tr-lg" style="display: none;">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 id="roomTitle" class="font-bold text-lg text-blue-600">Sala #</h3>
                                <button id="closePanelBtn" class="text-slate-500 hover:text-slate-700 font-bold text-xl">√ó</button>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div><strong>ID:</strong> <span id="roomId">-</span></div>
                                <div><strong>Nome:</strong> <span id="roomName">-</span></div>
                                <div><strong>Tipo:</strong> <span id="roomType">-</span></div>
                                <div><strong>Descrizione:</strong> <span id="roomDesc">-</span></div>
                                <div><strong>Dimensioni:</strong> <span id="roomDim">-</span></div>
                                <div><strong>Posizione:</strong> <span id="roomPos">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- SVG Container -->
                    <div id="roomMapContainer" style="width: 100%; height: 100%; overflow: hidden; background: #f8f9fa; position: relative;">
                        <svg id="networkPlanSVG" viewBox="0 0 1434 800" style="width: 100%; height: 100%; background: white; display: block;">
                            <defs>
                                <!-- Padr√£o para escadas (linhas magenta horizontais) -->
                                <pattern id="stairPattern" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse">
                                    <line x1="0" y1="4" x2="8" y2="4" stroke="#FF00FF" stroke-width="1.5"/>
                                </pattern>
                            </defs>
                            
                            <!-- Background -->
                            <rect x="0" y="0" width="1434" height="800" fill="#FFFFFF"/>
                            
                            <!-- Bordas -->
                            <line x1="0" y1="15" x2="1434" y2="15" stroke="#C41E3A" stroke-width="2"/>
                            <line x1="0" y1="785" x2="1434" y2="785" stroke="#008000" stroke-width="2"/>
                            <line x1="15" y1="0" x2="15" y2="800" stroke="#C41E3A" stroke-width="2"/>
                            <line x1="1419" y1="0" x2="1419" y2="800" stroke="#008000" stroke-width="2"/>
                            
                            <!-- Grid vertical (alternando verde/amarelo) -->
                            <g id="grid">
                                <line x1="130" y1="15" x2="130" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="165" y1="15" x2="165" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="230" y1="15" x2="230" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="265" y1="15" x2="265" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="330" y1="15" x2="330" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="365" y1="15" x2="365" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="430" y1="15" x2="430" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="465" y1="15" x2="465" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="530" y1="15" x2="530" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="565" y1="15" x2="565" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="630" y1="15" x2="630" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="665" y1="15" x2="665" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="730" y1="15" x2="730" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="765" y1="15" x2="765" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="830" y1="15" x2="830" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="865" y1="15" x2="865" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="930" y1="15" x2="930" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="965" y1="15" x2="965" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="1030" y1="15" x2="1030" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="1065" y1="15" x2="1065" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="1130" y1="15" x2="1130" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="1165" y1="15" x2="1165" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="1230" y1="15" x2="1230" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="1265" y1="15" x2="1265" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                                <line x1="1330" y1="15" x2="1330" y2="785" stroke="#00AA00" stroke-width="1" opacity="0.6"/>
                                <line x1="1365" y1="15" x2="1365" y2="785" stroke="#FFFF00" stroke-width="1" opacity="0.6"/>
                            </g>
                            
                            <!-- Paredes das Salas -->
                            <g id="rooms" stroke="#0000FF" stroke-width="3" fill="none">
                                <rect class="room" data-room="0" x="210" y="155" width="155" height="130"/>
                                <rect class="room" data-room="1" x="25" y="550" width="135" height="215"/>
                                <rect class="room room-stair" data-room="2" x="160" y="430" width="70" height="105" fill="url(#stairPattern)" stroke="#00AA00"/>
                                <rect class="room" data-room="3" x="25" y="130" width="80" height="130"/>
                                <rect class="room" data-room="4" x="110" y="85" width="75" height="180"/>
                                <rect class="room" data-room="5" x="193" y="85" width="60" height="150"/>
                                <rect class="room" data-room="6" x="261" y="85" width="78" height="145"/>
                                <rect class="room" data-room="7" x="347" y="85" width="75" height="150"/>
                                <rect class="room" data-room="8" x="440" y="85" width="250" height="130"/>
                                <rect class="room" data-room="9" x="930" y="200" width="140" height="165"/>
                                <rect class="room" data-room="10" x="1080" y="30" width="135" height="85"/>
                                <rect class="room" data-room="11" x="1080" y="123" width="135" height="85"/>
                                <rect class="room" data-room="12" x="1080" y="216" width="135" height="85"/>
                                <rect class="room" data-room="13" x="930" y="450" width="285" height="315"/>
                                <rect class="room" data-room="14" x="710" y="450" width="118" height="315"/>
                                <rect class="room" data-room="15" x="525" y="415" width="185" height="350"/>
                                <rect class="room" data-room="16" x="440" y="250" width="285" height="165"/>
                                <rect class="room" data-room="17" x="370" y="550" width="95" height="215"/>
                                <rect class="room" data-room="18" x="280" y="550" width="88" height="215"/>
                                <rect class="room" data-room="19" x="161" y="285" width="70" height="75"/>
                            </g>
                            
                            <!-- Escadas -->
                            <g id="stairs">
                                <rect x="165" y="435" width="60" height="95" fill="url(#stairPattern)" stroke="#00AA00" stroke-width="2"/>
                                <rect x="680" y="85" width="80" height="110" fill="url(#stairPattern)" stroke="#FF00FF" stroke-width="2"/>
                            </g>
                            
                            <!-- Paredes principais (linhas de conex√£o) -->
                            <g id="walls" stroke="#0000FF" stroke-width="3" fill="none">
                                <path d="M 25,280 L 25,130 L 110,130 L 110,85 L 193,85 L 193,115 L 210,115 L 210,85 L 261,85 L 261,115 L 347,115 L 347,85 L 422,85" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M 110,265 L 110,280 L 25,280" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M 160,360 L 160,430" stroke-linecap="round"/>
                                <path d="M 230,360 L 280,360 L 280,550" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M 370,415 L 440,415" stroke-linecap="round"/>
                                <path d="M 440,285 L 440,250" stroke-linecap="round"/>
                                <path d="M 525,360 L 710,360" stroke-linecap="round"/>
                                <path d="M 690,215 L 930,215" stroke-linecap="round"/>
                                <path d="M 930,280 L 930,200" stroke-linecap="round"/>
                                <path d="M 1070,200 L 1080,200" stroke-linecap="round"/>
                                <path d="M 1215,30 L 1215,450" stroke-linecap="round"/>
                            </g>
                            
                            <!-- Marcadores magenta -->
                            <g id="markers" fill="#FF00FF">
                                <rect x="21" y="26" width="8" height="8"/>
                                <rect x="106" y="26" width="8" height="8"/>
                                <rect x="276" y="26" width="8" height="8"/>
                                <rect x="418" y="26" width="8" height="8"/>
                                <rect x="686" y="26" width="8" height="8"/>
                                <rect x="926" y="26" width="8" height="8"/>
                                <rect x="1211" y="26" width="8" height="8"/>
                                <rect x="21" y="446" width="8" height="8"/>
                                <rect x="276" y="446" width="8" height="8"/>
                                <rect x="521" y="446" width="8" height="8"/>
                                <rect x="706" y="446" width="8" height="8"/>
                                <rect x="926" y="446" width="8" height="8"/>
                                <rect x="1211" y="446" width="8" height="8"/>
                                <rect x="21" y="761" width="8" height="8"/>
                                <rect x="276" y="761" width="8" height="8"/>
                                <rect x="418" y="761" width="8" height="8"/>
                                <rect x="706" y="761" width="8" height="8"/>
                                <rect x="926" y="761" width="8" height="8"/>
                                <rect x="1211" y="761" width="8" height="8"/>
                            </g>
                            
                            <!-- N√∫meros das Salas -->
                            <g id="numbers" font-family="Arial,sans-serif" font-weight="bold" font-size="38" fill="#0000FF" text-anchor="middle" dominant-baseline="middle">
                                <text data-room="0" x="287" y="220">0</text>
                                <text data-room="1" x="92" y="657">1</text>
                                <text data-room="2" x="195" y="482">2</text>
                                <text data-room="3" x="65" y="195">3</text>
                                <text data-room="4" x="147" y="175">4</text>
                                <text data-room="5" x="223" y="160">5</text>
                                <text data-room="6" x="300" y="157">6</text>
                                <text data-room="7" x="384" y="160">7</text>
                                <text data-room="8" x="565" y="150">8</text>
                                <text data-room="9" x="1000" y="282">9</text>
                                <text data-room="10" x="1147" y="72">10</text>
                                <text data-room="11" x="1147" y="165">11</text>
                                <text data-room="12" x="1147" y="258">12</text>
                                <text data-room="13" x="1072" y="607">13</text>
                                <text data-room="14" x="769" y="607">14</text>
                                <text data-room="15" x="617" y="590">15</text>
                                <text data-room="16" x="582" y="332">16</text>
                                <text data-room="17" x="417" y="657">17</text>
                                <text data-room="18" x="324" y="657">18</text>
                                <text data-room="19" x="196" y="322">19</text>
                            </g>
                            
                            <!-- Overlay interativo (preparado para futuro) -->
                            <g id="interactive" opacity="0">
                                <rect class="clickable" data-room="0" x="210" y="155" width="155" height="130" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="1" x="25" y="550" width="135" height="215" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="2" x="160" y="430" width="70" height="105" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="3" x="25" y="130" width="80" height="130" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="4" x="110" y="85" width="75" height="180" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="5" x="193" y="85" width="60" height="150" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="6" x="261" y="85" width="78" height="145" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="7" x="347" y="85" width="75" height="150" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="8" x="440" y="85" width="250" height="130" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="9" x="930" y="200" width="140" height="165" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="10" x="1080" y="30" width="135" height="85" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="11" x="1080" y="123" width="135" height="85" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="12" x="1080" y="216" width="135" height="85" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="13" x="930" y="450" width="285" height="315" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="14" x="710" y="450" width="118" height="315" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="15" x="525" y="415" width="185" height="350" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="16" x="440" y="250" width="285" height="165" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="17" x="370" y="550" width="95" height="215" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="18" x="280" y="550" width="88" height="215" fill="blue" opacity="0.1" cursor="pointer"/>
                                <rect class="clickable" data-room="19" x="161" y="285" width="70" height="75" fill="blue" opacity="0.1" cursor="pointer"/>
                            </g>
                        </svg>
                    </div>
                </div>

                <!-- Vista Lista Salas -->
                <div id="roomsListView" class="border border-slate-300 rounded-xl bg-white overflow-hidden" style="display: none;">
                    <div class="p-4">
                        <input type="text" id="roomSearchInput" placeholder="üîç Cerca sala o WallJack..." 
                               onkeyup="filterRoomsList()" 
                               class="w-full px-4 py-2 border border-slate-300 rounded-lg mb-4">
                        
                        <div id="roomsListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Lista dinamica delle salas con WallJacks -->
                        </div>
                    </div>
                </div>

                <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <p class="text-sm text-amber-800">
                        <strong>üí° Tip:</strong> Clicca su una sala nella mappa per vedere i dettagli dei punti WallJack. 
                        Usa la vista Lista per cercare velocemente una sala specifica.
                    </p>
                </div>
            </div>

            <!-- Tab 6: Activity Logs -->
            <div id="content-logs" class="tab-content">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">üìã Activity Logs</h2>
                        <p class="text-xs text-slate-500">Last 200 changes</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="logFilter" onchange="filterLogs()" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Activities</option>
                            <option value="device">Devices</option>
                            <option value="connection">Connections</option>
                            <option value="import">Import/Export</option>
                            <option value="auth">Authentication</option>
                        </select>
                        <button onclick="clearLogs()" class="edit-mode-only bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm" style="display:none;">
                            üóëÔ∏è Clear Logs
                        </button>
                        <button onclick="exportLogs()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-1.5 px-3 rounded-lg text-sm">
                            üì• Export Logs
                        </button>
                    </div>
                </div>
                <div id="logsContainer" class="border border-slate-200 rounded-xl overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 text-left font-semibold text-slate-700 w-40">Timestamp</th>
                                <th class="px-3 py-2 text-left font-semibold text-slate-700 w-24">Action</th>
                                <th class="px-3 py-2 text-left font-semibold text-slate-700 w-24">Type</th>
                                <th class="px-3 py-2 text-left font-semibold text-slate-700">Details</th>
                                <th class="px-3 py-2 text-left font-semibold text-slate-700 w-24">User</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-slate-100">
                            <tr><td colspan="5" class="px-3 py-8 text-center text-slate-400">No logs yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">üîê Edit Mode Access</h2>
                <p class="text-sm text-slate-500 mt-1">Enter your credentials to edit</p>
            </div>
            <form id="loginForm" onsubmit="Auth.handleLoginSubmit(event)">
                <div class="space-y-4">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                        <input type="text" id="loginUsername" name="username" required autocomplete="username"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" name="password" required autocomplete="current-password"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="loginError" class="text-red-500 text-sm text-center hidden"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="Auth.hideLoginModal()"
                        class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" id="loginSubmitBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Legend Modal -->
    <div id="legendModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeLegendModal(event)">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl max-h-[90vh] overflow-y-auto mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800">üìã Device Type Legend</h2>
                <button onclick="closeLegendModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div id="legendModalContent">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Load external JavaScript modules with cache-buster -->
    <script src="js/auth.js?v=3.1.5"></script>
    <script src="js/app.js?v=3.1.5"></script>
    <script src="js/ui-updates.js?v=3.1.5"></script>
    <script src="js/features.js?v=3.1.5"></script>
    
    <!-- Update connections count when list lists -->
    <script>
        (function() {
            var origUpdateConnList = window.updateConnectionsList;
            window.updateConnectionsList = function() {
                origUpdateConnList.apply(this, arguments);
                var countEl = document.getElementById('connectionsCount');
                if (countEl && window.appState) {
                    countEl.textContent = appState.connections.length;
                }
                // Update location filter
                if (typeof LocationFilter !== 'undefined') {
                    LocationFilter.update();
                }
            };
            
            var origUpdateDevList = window.updateDevicesList;
            window.updateDevicesList = function() {
                origUpdateDevList.apply(this, arguments);
                // Update location filter
                if (typeof LocationFilter !== 'undefined') {
                    LocationFilter.update();
                }
            };
        })();
    </script>

    <!-- Rooms Management Functions -->
    <script>
        // Toggle between map and list view
        function toggleRoomsView() {
            const mode = document.getElementById('roomsViewMode').value;
            const mapView = document.getElementById('roomsMapView');
            const listView = document.getElementById('roomsListView');
            
            if (mode === 'map') {
                mapView.style.display = 'block';
                listView.style.display = 'none';
            } else {
                mapView.style.display = 'none';
                listView.style.display = 'block';
                updateRoomsList();
            }
        }

        // Update rooms list with WallJack info
        function updateRoomsList() {
            const container = document.getElementById('roomsListContainer');
            if (!container) return;

            // Get all WallJack devices
            const walljacks = appState.devices.filter(d => d.type === 'WallJack');
            
            // Group by location (room)
            const roomsMap = {};
            walljacks.forEach(wj => {
                const room = wj.location || 'Sala Sconosciuta';
                if (!roomsMap[room]) {
                    roomsMap[room] = [];
                }
                roomsMap[room].push(wj);
            });

            // Generate HTML
            const rooms = Object.keys(roomsMap).sort();
            container.innerHTML = rooms.map(room => {
                const wjs = roomsMap[room];
                const connectedCount = wjs.filter(w => {
                    return appState.connections.some(c => 
                        c.sourceDevice === w.name || c.destinationDevice === w.name
                    );
                }).length;

                return `
                    <div class="border border-slate-300 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-slate-800 mb-2 flex items-center justify-between">
                            <span>üìç ${room}</span>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${wjs.length} WJ</span>
                        </h3>
                        <div class="space-y-1 text-sm">
                            <p class="text-slate-600">
                                <span class="font-semibold">Punti:</span> ${wjs.map(w => w.name).join(', ')}
                            </p>
                            <p class="text-slate-600">
                                <span class="font-semibold">Connessi:</span> 
                                <span class="${connectedCount > 0 ? 'text-green-600' : 'text-amber-600'}">${connectedCount}/${wjs.length}</span>
                            </p>
                            ${wjs.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-slate-200">
                                    ${wjs.slice(0, 5).map(w => {
                                        const conn = appState.connections.find(c => 
                                            c.sourceDevice === w.name || c.destinationDevice === w.name
                                        );
                                        const status = conn ? 'üü¢' : '‚ö™';
                                        return `<div class="text-xs text-slate-500">${status} ${w.name}${w.portName ? ` (${w.portName})` : ''}</div>`;
                                    }).join('')}
                                    ${wjs.length > 5 ? `<div class="text-xs text-slate-400 mt-1">... e altri ${wjs.length - 5}</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (rooms.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-slate-400">
                        <p>üì≠ Nessun WallJack configurato</p>
                        <p class="text-sm mt-2">Aggiungi dispositivi di tipo WallJack per popolare la mappa delle salas</p>
                    </div>
                `;
            }
        }

        // Filter rooms list
        function filterRoomsList() {
            const searchTerm = document.getElementById('roomSearchInput').value.toLowerCase();
            const rooms = document.querySelectorAll('#roomsListContainer > div');
            
            rooms.forEach(room => {
                const text = room.textContent.toLowerCase();
                room.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Update rooms list when switching to the tab
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.id === 'tab-rooms') {
                    const mode = document.getElementById('roomsViewMode').value;
                    if (mode === 'list') {
                        updateRoomsList();
                    } else {
                        // Initialize SVG interactions when tab is opened
                        setTimeout(initNetworkMapPlan, 100);
                    }
                }
            });
        });
        
        // Initialize SVG Network Plan on load
        document.addEventListener('DOMContentLoaded', () => {
            initNetworkMapPlan();
        });
    </script>
    
    <!-- SVG Network Plan Interactive Functions - COMPLETA -->
    <script>
        // Dati das 20 salas (do JSON)
        const roomsData = [
            {id: 0, name: "Sala 0", type: "regular", x: 210, y: 155, width: 155, height: 130, desc: ""},
            {id: 1, name: "Sala 1", type: "regular", x: 25, y: 550, width: 135, height: 215, desc: ""},
            {id: 2, name: "Sala 2", type: "stairwell", x: 160, y: 430, width: 70, height: 105, desc: "Stairwell"},
            {id: 3, name: "Sala 3", type: "regular", x: 25, y: 130, width: 80, height: 130, desc: ""},
            {id: 4, name: "Sala 4", type: "regular", x: 110, y: 85, width: 75, height: 180, desc: ""},
            {id: 5, name: "Sala 5", type: "regular", x: 193, y: 85, width: 60, height: 150, desc: ""},
            {id: 6, name: "Sala 6", type: "regular", x: 261, y: 85, width: 78, height: 145, desc: ""},
            {id: 7, name: "Sala 7", type: "regular", x: 347, y: 85, width: 75, height: 150, desc: ""},
            {id: 8, name: "Sala 8", type: "regular", x: 440, y: 85, width: 250, height: 130, desc: ""},
            {id: 9, name: "Sala 9", type: "regular", x: 930, y: 200, width: 140, height: 165, desc: ""},
            {id: 10, name: "Sala 10", type: "regular", x: 1080, y: 30, width: 135, height: 85, desc: ""},
            {id: 11, name: "Sala 11", type: "regular", x: 1080, y: 123, width: 135, height: 85, desc: ""},
            {id: 12, name: "Sala 12", type: "regular", x: 1080, y: 216, width: 135, height: 85, desc: ""},
            {id: 13, name: "Sala 13", type: "regular", x: 930, y: 450, width: 285, height: 315, desc: ""},
            {id: 14, name: "Sala 14", type: "regular", x: 710, y: 450, width: 118, height: 315, desc: ""},
            {id: 15, name: "Sala 15", type: "regular", x: 525, y: 415, width: 185, height: 350, desc: ""},
            {id: 16, name: "Sala 16", type: "regular", x: 440, y: 250, width: 285, height: 165, desc: ""},
            {id: 17, name: "Sala 17", type: "regular", x: 370, y: 550, width: 95, height: 215, desc: ""},
            {id: 18, name: "Sala 18", type: "regular", x: 280, y: 550, width: 88, height: 215, desc: ""},
            {id: 19, name: "Sala 19", type: "stairwell", x: 161, y: 285, width: 70, height: 75, desc: "Stairwell"}
        ];

        let mapState = {
            zoom: 1,
            panX: 0,
            panY: 0,
            selectedRoomId: null
        };

        function initNetworkMapPlan() {
            const svg = document.getElementById('networkPlanSVG');
            const container = document.getElementById('roomMapContainer');
            if (!svg || !container) return;

            // Eventos de zoom
            document.getElementById('zoomInBtn').addEventListener('click', () => updateZoom(1.2));
            document.getElementById('zoomOutBtn').addEventListener('click', () => updateZoom(0.8));
            document.getElementById('zoomResetBtn').addEventListener('click', resetView);

            // Mouse wheel zoom
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                updateZoom(e.deltaY > 0 ? 0.9 : 1.1);
            }, { passive: false });

            // Click nas salas
            const clickableRects = svg.querySelectorAll('#interactive .clickable');
            clickableRects.forEach(rect => {
                rect.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const roomId = parseInt(rect.getAttribute('data-room'));
                    selectRoom(roomId);
                });

                rect.addEventListener('mouseenter', () => {
                    const roomId = parseInt(rect.getAttribute('data-room'));
                    const roomRect = svg.querySelector(`.room[data-room="${roomId}"]`);
                    if (roomRect) {
                        roomRect.style.opacity = '0.7';
                        roomRect.style.filter = 'drop-shadow(0 0 5px rgba(0,0,255,0.5))';
                    }
                });

                rect.addEventListener('mouseleave', () => {
                    const roomId = parseInt(rect.getAttribute('data-room'));
                    const roomRect = svg.querySelector(`.room[data-room="${roomId}"]`);
                    if (roomRect && mapState.selectedRoomId !== roomId) {
                        roomRect.style.opacity = '1';
                        roomRect.style.filter = 'none';
                    }
                });
            });

            // Fechar painel
            document.getElementById('closePanelBtn').addEventListener('click', () => {
                mapState.selectedRoomId = null;
                document.getElementById('roomDetailsPanel').style.display = 'none';
                svg.querySelectorAll(`.room[data-room]`).forEach(room => {
                    room.style.opacity = '1';
                    room.style.filter = 'none';
                });
            });
        }

        function updateZoom(factor) {
            mapState.zoom = Math.max(0.5, Math.min(3, mapState.zoom * factor));
            applyTransform();
        }

        function resetView() {
            mapState.zoom = 1;
            mapState.panX = 0;
            mapState.panY = 0;
            mapState.selectedRoomId = null;
            applyTransform();
            document.getElementById('roomDetailsPanel').style.display = 'none';
        }

        function applyTransform() {
            const svg = document.getElementById('networkPlanSVG');
            const container = document.getElementById('roomMapContainer');
            
            if (!svg || !container) return;

            const transform = `scale(${mapState.zoom}) translate(${mapState.panX}px, ${mapState.panY}px)`;
            svg.style.transform = transform;
            svg.style.transformOrigin = '0 0';

            document.getElementById('zoomLevel').textContent = Math.round(mapState.zoom * 100) + '%';
        }

        function selectRoom(roomId) {
            mapState.selectedRoomId = roomId;
            const room = roomsData.find(r => r.id === roomId);
            const svg = document.getElementById('networkPlanSVG');

            if (!room) return;

            // Highlight room
            svg.querySelectorAll(`.room[data-room]`).forEach(r => {
                const rid = parseInt(r.getAttribute('data-room'));
                if (rid === roomId) {
                    r.style.opacity = '1';
                    r.style.filter = 'drop-shadow(0 0 8px rgba(255,0,255,0.8))';
                } else {
                    r.style.opacity = '0.4';
                }
            });

            // Show panel
            const panel = document.getElementById('roomDetailsPanel');
            document.getElementById('roomTitle').textContent = `Sala ${room.id}`;
            document.getElementById('roomId').textContent = room.id;
            document.getElementById('roomName').textContent = room.name;
            document.getElementById('roomType').textContent = room.type;
            document.getElementById('roomDesc').textContent = room.desc || '(nessuna)';
            document.getElementById('roomDim').textContent = `${room.width}√ó${room.height}px`;
            document.getElementById('roomPos').textContent = `x:${room.x}, y:${room.y}`;
            panel.style.display = 'block';
        }
    </script>

</body>
</html>
